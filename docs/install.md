# Building from Source

Building from source requires you to do three things:

1. Setup an LLVM Clang toolchain.

2. Build and install required 3rd-party c++ libraries.

3. Build the 1st-party services.

## Setting up LLVM Clang

Builds have been verified to work with the LLVM Clang version 16+ on x86
Darwin. Other setups may also work, but I haven't tested them.

1. Install LLVM Clang using Homebrew:

```shell
brew install llvm
```

2. Configure shell to use LLVM Clang instead Apple Clang:

```shell
# prepend LLVM binaries to PATH so they are used before Apple Clang
export PATH=/usr/local/opt/llvm/bin:$PATH
export LDFLAGS="-L/usr/local/opt/llvm/lib"
export CPPFLAGS="-I/usr/local/opt/llvm/include"
export CC=/usr/local/opt/llvm/bin/clang
export CXX=/usr/local/opt/llvm/bin/clang++
```

## Building and Installing Required 3rd-Party Libraries

This project uses the following libraries:

- [gRPC](https://github.com/grpc/grpc): for service and client building
- [abseil](https://github.com/abseil/abseil-cpp): for various utilities; we
actually just use the version pulled in by gRPC to simplify setup
- [FAISS](https://github.com/facebookresearch/faiss): to provide the actual
vector search

and the following libraries for development:
- [GoogleTest](https://github.com/google/googletest): for c++ unittesting

To simplify development, I've chosen to build and install static libraries
for gRPC and FAISS in an isolated directory:

```shell
export MY_INSTALL_DIR=$HOME/.local
```

In other words, you'll also need to build and install gRPC and abseil manually.
There are instructions below on how to do that.

Abseil is installed automatically as part of gRPC and GoogleTest is installed
by CMake, so nothing more needs to be done for those.

In the future, I might pull these into the CMake build workflow to avoid
these extra manual build steps.

#### Installing gRPC

1. Install `grpc`  with c++ support, following the instructions at
https://grpc.io/docs/languages/cpp/quickstart/. 

2. Install `protoc` protobuf compiler, following
https://grpc.io/docs/protoc-installation/:

```shell
$ brew install protobuf
$ protoc --version
```

### Install FAISS

Reference: https://github.com/facebookresearch/faiss.

1. Clone the FAISS repository:

```shell
$ git clone git@github.com:facebookresearch/faiss.git && cd faiss
```

2. Configure the build system using `cmake`:

```shell
export MY_INSTALL_DIR=~/.local
cmake \
    -DCMAKE_INSTALL_PREFIX=$MY_INSTALL_DIR \
    -DCMAKE_BUILD_TYPE=Release \
    -DFAISS_ENABLE_C_API=OFF \
    -DFAISS_OPT_LEVEL=generic \
    -DFAISS_ENABLE_GPU=OFF \
    -DFAISS_ENABLE_PYTHON=OFF \
    -DBUILD_TESTING=OFF \
    -B build \
    .
```

3. Build FAISS:

```shell
make -C build -j faiss
```

Note: This creates the `libfaiss.a` static library (or `libfaiss.so` if
`-DBUILD_SHARED_LIBS=on`), located under `build/faiss`.

4. Install into ~/.local:

```shell
make -C build install
```


## Building and running the 1st-party services

Most 1st-party development workflows, including building and running tests, can
be done through the [Makefile](../Makefile) at the repository root.

1. Configure the build system using CMake:

```shell
$ make configure
```

2. Build all targets:

```shell
$ make build
```

3. Run the unittests:

```shell
$ make test
```

4. Run a sharded

## Running Integration Tests

You can run integration tests using a running index service and scripts that
use the Python stubs autogenerated from [.proto](../src/proto) definitions.

### Setting up a Python Environment

This assumes you have a version of Python 3.8+ installed and configured as
your default Python. You can see what version you have with:

```shell
$ python --version
```

1. Create a new virtualenv:

```shell
$ python -m virtualenv venv && source venv/bin/activate
```

2. Install 3rd-party dependencies:

```shell
$ pip install -r src/python/requirements.txt
```

### Running and Testing an Index Service

1. Start a new index service:

```shell
$ make run_single
```

2. Run integration tests against the service:

```shell
$ make it
```

